<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جاروی جادویی - نسخه پیشرفته</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@latest/Vazirmatn-font-face.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 80vh;
            transform-style: preserve-3d;
        }
        
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            transition: transform 0.5s, opacity 0.5s;
            backface-visibility: hidden;
            transform-style: preserve-3d;
            opacity: 0;
            pointer-events: none;
        }
        
        .screen.active {
            opacity: 1;
            pointer-events: all;
        }
        
        #main-menu {
            z-index: 10;
        }
        
        #game-screen {
            z-index: 5;
        }
        
        #game-over {
            z-index: 8;
        }
        
        #shop {
            z-index: 9;
        }
        
        #question-screen {
            z-index: 15;
            background: rgba(0, 0, 0, 0.9);
        }
        
        #tutorial {
            z-index: 20;
            background: rgba(0, 0, 0, 0.9);
        }
        
        #progress-report {
            z-index: 18;
            background: rgba(0, 0, 0, 0.9);
        }
        
        #category-screen {
            z-index: 25;
            background: rgba(0, 0, 0, 0.9);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: translateZ(30px);
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            transform: translateZ(20px);
        }
        
        h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            transform: translateZ(15px);
        }
        
        p {
            font-size: 1.2rem;
            margin-bottom: 15px;
            line-height: 1.5;
            transform: translateZ(10px);
        }
        
        .btn {
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            border: none;
            color: white;
            padding: 12px 25px;
            font-size: 1.2rem;
            border-radius: 50px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateZ(15px);
        }
        
        .btn:hover {
            transform: translateZ(15px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .btn-option {
            width: 100%;
            text-align: right;
            padding: 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
            color: white;
            font-size: 1.1rem;
        }
        
        .btn-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff8a00;
        }
        
        #game-area {
            position: relative;
            width: 100%;
            height: 80%;
            background: linear-gradient(to bottom, #2c3e50, #4a6491);
            border-radius: 10px;
            overflow: hidden;
            transform-style: preserve-3d;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }
        
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        #broom-ui {
            position: absolute;
            width: 60px;
            height: 100px;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateZ(20px);
            transition: left 0.1s;
            z-index: 15;
            pointer-events: none;
        }
        
        .broom-body {
            position: absolute;
            width: 10px;
            height: 80px;
            background: linear-gradient(to bottom, #8B4513, #A0522D);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 5px 5px 0 0;
        }
        
        .broom-head {
            position: absolute;
            width: 50px;
            height: 20px;
            background: linear-gradient(to bottom, #D2691E, #8B4513);
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 10px 10px 0 0;
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.3);
        }
        
        #magnet-effect {
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 2px dashed gold;
            display: none;
            pointer-events: none;
            z-index: 5;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .stat {
            font-size: 1.2rem;
        }
        
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transform: translateZ(10px);
        }
        
        .upgrade-info {
            text-align: right;
            flex: 1;
        }
        
        .upgrade-price {
            display: flex;
            align-items: center;
        }
        
        .coin {
            color: gold;
            margin: 0 5px;
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateZ(20px) translateY(0px); }
            50% { transform: translateZ(20px) translateY(-10px); }
            100% { transform: translateZ(20px) translateY(0px); }
        }
        
        .question-container {
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            padding: 10px;
        }
        
        .question-text {
            font-size: 1.3rem;
            margin-bottom: 20px;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .correct {
            background: linear-gradient(45deg, #4CAF50, #8BC34A) !important;
        }
        
        .incorrect {
            background: linear-gradient(45deg, #F44336, #E91E63) !important;
        }
        
        #question-result {
            margin-top: 15px;
            font-size: 1.2rem;
            min-height: 30px;
        }
        
        .level-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            z-index: 10;
        }
        
        @keyframes levelUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .level-up-animation {
            animation: levelUp 0.5s ease-in-out;
        }
        
        .tutorial-steps {
            width: 100%;
            margin: 20px 0;
        }
        
        .step {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-right: 4px solid #ff8a00;
        }
        
        .category-btn {
            width: 100%;
            margin: 5px 0;
            text-align: center;
        }
        
        .category-btn.selected {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }
        
        .progress-item {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            border-radius: 5px;
            transition: width 0.5s;
        }
        
        .creator-credit {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .transition-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .transition-overlay.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- لایه انتقال -->
        <div class="transition-overlay" id="transition-overlay"></div>
        
        <!-- صفحه اصلی -->
        <div id="main-menu" class="screen active">
            <h1 class="floating">جاروی جادویی - نسخه پیشرفته</h1>
            <p>لکه‌ها را با کشیدن انگشت تمیز کنید!</p>
            <p>لکه‌های طلایی سوالات درسی دارند - پاسخ صحیح = ۱۰ سکه!</p>
            <button id="start-btn" class="btn">شروع بازی</button>
            <button id="tutorial-btn" class="btn">آموزش بازی</button>
            <button id="shop-btn" class="btn">فروشگاه</button>
            <button id="category-btn" class="btn">انتخاب درس‌ها</button>
            <div class="stats">
                <div class="stat">رکورد: <span id="high-score">0</span></div>
                <div class="stat">سکه: <span id="total-coins">0</span></div>
                <div class="stat">سطح: <span id="player-level">1</span></div>
            </div>
            <div class="creator-credit">ساخته شده توسط آراد مقدم</div>
        </div>
        
        <!-- صفحه بازی -->
        <div id="game-screen" class="screen">
            <div class="level-indicator">سطح <span id="current-level">1</span></div>
            <div class="stats">
                <div class="stat">امتیاز: <span id="score">0</span></div>
                <div class="stat">سکه: <span id="coins">0</span></div>
                <div class="stat">سرعت: <span id="speed">1x</span></div>
            </div>
            <div id="game-area">
                <canvas id="game-canvas"></canvas>
                <div id="game-ui">
                    <div id="broom-ui">
                        <div class="broom-body"></div>
                        <div class="broom-head"></div>
                    </div>
                    <div id="magnet-effect"></div>
                </div>
            </div>
            <button id="pause-btn" class="btn">توقف</button>
        </div>
        
        <!-- صفحه پایان بازی -->
        <div id="game-over" class="screen">
            <h2>بازی تمام شد!</h2>
            <p>امتیاز شما: <span id="final-score">0</span></p>
            <p>رکورد جدید: <span id="new-record">0</span></p>
            <p>سکه‌های کسب شده: <span id="earned-coins">0</span></p>
            <p>سطح فعلی: <span id="final-level">1</span></p>
            <button id="restart-btn" class="btn">دوباره بازی کنید</button>
            <button id="menu-btn" class="btn">منوی اصلی</button>
            <button id="report-btn" class="btn">مشاهده گزارش</button>
        </div>
        
        <!-- صفحه فروشگاه -->
        <div id="shop" class="screen">
            <h2>فروشگاه</h2>
            <p>جاروی خود را ارتقا دهید!</p>
            
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <h3>جاروی سریع‌تر</h3>
                    <p>سرعت حرکت جارو افزایش می‌یابد (سطح فعلی: <span id="speed-level">1</span>)</p>
                </div>
                <div class="upgrade-price">
                    <span class="coin" id="speed-price">50</span>
                    <button class="btn upgrade-btn" data-upgrade="speed">خرید</button>
                </div>
            </div>
            
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <h3>آهنربای جارو</h3>
                    <p>جارو لکه‌ها را از فاصله دورتر جذب می‌کند</p>
                </div>
                <div class="upgrade-price">
                    <span class="coin">100</span>
                    <button class="btn upgrade-btn" data-upgrade="magnet">خرید</button>
                </div>
            </div>
            
            <div class="upgrade-item">
                <div class="upgrade-info">
                    <h3>جاروی بزرگ‌تر</h3>
                    <p>مساحت تمیزکاری جارو افزایش می‌یابد (سطح فعلی: <span id="size-level">1</span>)</p>
                </div>
                <div class="upgrade-price">
                    <span class="coin" id="size-price">75</span>
                    <button class="btn upgrade-btn" data-upgrade="size">خرید</button>
                </div>
            </div>
            
            <button id="shop-back-btn" class="btn">بازگشت</button>
        </div>
        
        <!-- صفحه سوالات -->
        <div id="question-screen" class="screen">
            <h2>سوال درسی</h2>
            <p>پاسخ صحیح = ۱۰ سکه پاداش!</p>
            
            <div class="question-container">
                <div class="question-text" id="question-text">سوال اینجا نمایش داده می‌شود</div>
                
                <div class="options-container">
                    <button class="btn-option" data-option="1" id="option1">گزینه ۱</button>
                    <button class="btn-option" data-option="2" id="option2">گزینه ۲</button>
                    <button class="btn-option" data-option="3" id="option3">گزینه ۳</button>
                    <button class="btn-option" data-option="4" id="option4">گزینه ۴</button>
                </div>
                
                <div id="question-result"></div>
            </div>
            
            <button id="continue-btn" class="btn" style="display: none;">ادامه بازی</button>
        </div>
        
        <!-- صفحه آموزش -->
        <div id="tutorial" class="screen">
            <h2>آموزش بازی جاروی جادویی</h2>
            
            <div class="tutorial-steps">
                <div class="step">
                    <p>جارو را با کشیدن انگشت به چپ و راست حرکت دهید</p>
                </div>
                <div class="step">
                    <p>لکه‌های معمولی را برای کسب امتیاز تمیز کنید</p>
                </div>
                <div class="step">
                    <p>لکه‌های طلایی شامل سوالات درسی هستند</p>
                </div>
                <div class="step">
                    <p>پاسخ صحیح = ۱۰ سکه پاداش!</p>
                </div>
                <div class="step">
                    <p>با افزایش امتیاز، سطح بازی و سرعت افزایش می‌یابد</p>
                </div>
                <div class="step">
                    <p>از فروشگاه برای ارتقای جارو استفاده کنید</p>
                </div>
            </div>
            
            <button id="tutorial-close" class="btn">شروع بازی</button>
        </div>
        
        <!-- صفحه گزارش پیشرفت -->
        <div id="progress-report" class="screen">
            <h2>گزارش پیشرفت آموزشی</h2>
            
            <div class="progress-item">
                <span>زمان بازی:</span>
                <span id="play-time">0 دقیقه</span>
            </div>
            
            <div class="progress-item">
                <span>کل سوالات پاسخ داده شده:</span>
                <span id="total-questions">0</span>
            </div>
            
            <h3>عملکرد در هر درس:</h3>
            
            <div id="subject-progress">
                <!-- اینجا با جاوااسکریپت پر می‌شود -->
            </div>
            
            <h3>نقاط قوت:</h3>
            <div id="strengths-list">
                <!-- اینجا با جاوااسکریپت پر می‌شود -->
            </div>
            
            <h3>نیاز به تمرین بیشتر:</h3>
            <div id="weaknesses-list">
                <!-- اینجا با جاوااسکریپت پر می‌شود -->
            </div>
            
            <button id="report-close" class="btn">بازگشت</button>
        </div>
        
        <!-- صفحه انتخاب درس -->
        <div id="category-screen" class="screen">
            <h2>انتخاب درس‌ها</h2>
            <p>درس‌هایی که می‌خواهید در بازی بیاموزید را انتخاب کنید:</p>
            <div id="category-list" style="width: 100%; margin: 20px 0;">
                <!-- با جاوااسکریپت پر می‌شود -->
            </div>
            <button id="category-save" class="btn">ذخیره و بازگشت</button>
        </div>
    </div>

    <script>
        // عناصر DOM
        const screens = {
            mainMenu: document.getElementById('main-menu'),
            gameScreen: document.getElementById('game-screen'),
            gameOver: document.getElementById('game-over'),
            shop: document.getElementById('shop'),
            questionScreen: document.getElementById('question-screen'),
            tutorial: document.getElementById('tutorial'),
            progressReport: document.getElementById('progress-report'),
            categoryScreen: document.getElementById('category-screen')
        };
        
        const transitionOverlay = document.getElementById('transition-overlay');
        const gameCanvas = document.getElementById('game-canvas');
        const ctx = gameCanvas.getContext('2d');
        const broomUI = document.getElementById('broom-ui');
        const magnetEffect = document.getElementById('magnet-effect');
        const gameArea = document.getElementById('game-area');
        
        // دکمه‌ها
        const startBtn = document.getElementById('start-btn');
        const tutorialBtn = document.getElementById('tutorial-btn');
        const shopBtn = document.getElementById('shop-btn');
        const categoryBtn = document.getElementById('category-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const restartBtn = document.getElementById('restart-btn');
        const menuBtn = document.getElementById('menu-btn');
        const shopBackBtn = document.getElementById('shop-back-btn');
        const continueBtn = document.getElementById('continue-btn');
        const tutorialCloseBtn = document.getElementById('tutorial-close');
        const reportBtn = document.getElementById('report-btn');
        const reportCloseBtn = document.getElementById('report-close');
        const categorySaveBtn = document.getElementById('category-save');
        
        // عناصر آماری
        const highScoreElement = document.getElementById('high-score');
        const totalCoinsElement = document.getElementById('total-coins');
        const playerLevelElement = document.getElementById('player-level');
        const scoreElement = document.getElementById('score');
        const coinsElement = document.getElementById('coins');
        const speedElement = document.getElementById('speed');
        const currentLevelElement = document.getElementById('current-level');
        const finalScoreElement = document.getElementById('final-score');
        const newRecordElement = document.getElementById('new-record');
        const earnedCoinsElement = document.getElementById('earned-coins');
        const finalLevelElement = document.getElementById('final-level');
        const speedLevelElement = document.getElementById('speed-level');
        const sizeLevelElement = document.getElementById('size-level');
        const speedPriceElement = document.getElementById('speed-price');
        const sizePriceElement = document.getElementById('size-price');
        
        // عناصر سوالات
        const questionText = document.getElementById('question-text');
        const option1 = document.getElementById('option1');
        const option2 = document.getElementById('option2');
        const option3 = document.getElementById('option3');
        const option4 = document.getElementById('option4');
        const questionResult = document.getElementById('question-result');
        
        // عناصر گزارش
        const playTimeElement = document.getElementById('play-time');
        const totalQuestionsElement = document.getElementById('total-questions');
        const subjectProgressElement = document.getElementById('subject-progress');
        const strengthsListElement = document.getElementById('strengths-list');
        const weaknessesListElement = document.getElementById('weaknesses-list');
        
        // لیست دسته‌بندی‌ها
        const categoryList = document.getElementById('category-list');
        
        // متغیرهای بازی
        let gameActive = false;
        let score = 0;
        let coins = 0;
        let speed = 1;
        let highScore = 0;
        let totalCoins = 0;
        let playerLevel = 1;
        let currentLevel = 1;
        let broomPosition = 50;
        let stains = [];
        let specialStains = [];
        let stainInterval;
        let specialStainInterval;
        let gameLoop;
        let lastTimestamp = 0;
        let currentQuestion = null;
        let questionAnswered = false;
        let startTime = 0;
        let playTime = 0;
        let selectedCategories = ["ریاضی", "علوم", "فارسی"];
        
        // ارتقاها
        let upgrades = {
            speed: 1,
            magnet: false,
            size: 1
        };
        
        // پیشرفت آموزشی
        let learningProgress = {
            "ریاضی": { correct: 0, total: 0 },
            "علوم": { correct: 0, total: 0 },
            "فارسی": { correct: 0, total: 0 },
            "مطالعات اجتماعی": { correct: 0, total: 0 },
            "دینی": { correct: 0, total: 0 },
            "انگلیسی": { correct: 0, total: 0 }
        };
        
        // آستانه‌های سطح
        const levelThresholds = [100, 300, 600, 1000, 1500, 2100, 2800, 3600, 4500, 5500];
        
        // بانک سوالات پایه هفتم
        const questions = [
            // ریاضی
            {
                subject: "ریاضی",
                question: "حاصل عبارت ۳ × (۴ + ۵) چیست؟",
                options: ["۲۷", "۱۷", "۳۷", "۱۲"],
                correct: 1
            },
            {
                subject: "ریاضی",
                question: "کسر ۳/۴ معادل کدام گزینه است؟",
                options: ["۰.۲۵", "۰.۵", "۰.۷۵", "۱.۲۵"],
                correct: 3
            },
            // علوم
            {
                subject: "علوم",
                question: "کدام یک از سیارات منظومه شمسی دارای حلقه است؟",
                options: ["مریخ", "زهره", "زحل", "عطارد"],
                correct: 3
            },
            {
                subject: "علوم",
                question: "عمل فتوسنتز در کدام بخش گیاه انجام می‌شود؟",
                options: ["ریشه", "ساقه", "برگ", "گل"],
                correct: 3
            },
            // فارسی
            {
                subject: "فارسی",
                question: "مترادف کلمه 'شاد' چیست؟",
                options: ["غمگین", "خوشحال", "عصبی", "خسته"],
                correct: 2
            },
            {
                subject: "فارسی",
                question: "کدام یک از موارد زیر 'ضمیر' نیست؟",
                options: ["من", "تو", "او", "کتاب"],
                correct: 4
            }
        ];
        
        // مدیریت نمایش صفحات
        function showScreen(screenName) {
            // پنهان کردن همه صفحات
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // نمایش صفحه مورد نظر با انیمیشن
            transitionOverlay.classList.add('active');
            
            setTimeout(() => {
                if (screens[screenName]) {
                    screens[screenName].classList.add('active');
                }
                transitionOverlay.classList.remove('active');
            }, 300);
        }
        
        // بارگذاری داده‌ها از localStorage
        function loadGameData() {
            highScore = parseInt(localStorage.getItem('highScore')) || 0;
            totalCoins = parseInt(localStorage.getItem('totalCoins')) || 0;
            playerLevel = parseInt(localStorage.getItem('playerLevel')) || 1;
            upgrades.speed = parseInt(localStorage.getItem('upgradeSpeed')) || 1;
            upgrades.magnet = localStorage.getItem('upgradeMagnet') === 'true';
            upgrades.size = parseInt(localStorage.getItem('upgradeSize')) || 1;
            
            // بارگذاری پیشرفت آموزشی
            const savedProgress = localStorage.getItem('learningProgress');
            if (savedProgress) {
                learningProgress = JSON.parse(savedProgress);
            }
            
            // بارگذاری دسته‌بندی‌های انتخاب شده
            const savedCategories = localStorage.getItem('selectedCategories');
            if (savedCategories) {
                selectedCategories = JSON.parse(savedCategories);
            }
            
            // به‌روزرسانی UI
            highScoreElement.textContent = highScore;
            totalCoinsElement.textContent = totalCoins;
            playerLevelElement.textContent = playerLevel;
            speedLevelElement.textContent = upgrades.speed;
            sizeLevelElement.textContent = upgrades.size;
            speedPriceElement.textContent = 50 * upgrades.speed;
            sizePriceElement.textContent = 75 * upgrades.size;
        }
        
        // ذخیره داده‌ها در localStorage
        function saveGameData() {
            localStorage.setItem('highScore', highScore);
            localStorage.setItem('totalCoins', totalCoins);
            localStorage.setItem('playerLevel', playerLevel);
            localStorage.setItem('upgradeSpeed', upgrades.speed);
            localStorage.setItem('upgradeMagnet', upgrades.magnet);
            localStorage.setItem('upgradeSize', upgrades.size);
            localStorage.setItem('learningProgress', JSON.stringify(learningProgress));
            localStorage.setItem('selectedCategories', JSON.stringify(selectedCategories));
        }
        
        // شروع بازی
        function startGame() {
            showScreen('gameScreen');
            gameActive = true;
            score = 0;
            coins = 0;
            speed = 1;
            currentLevel = 1;
            stains = [];
            specialStains = [];
            startTime = Date.now();
            
            // تنظیم اندازه Canvas
            gameCanvas.width = gameArea.offsetWidth;
            gameCanvas.height = gameArea.offsetHeight;
            
            // به‌روزرسانی UI
            scoreElement.textContent = score;
            coinsElement.textContent = coins;
            speedElement.textContent = speed + 'x';
            currentLevelElement.textContent = currentLevel;
            
            // تنظیم موقعیت اولیه جارو
            broomPosition = 50;
            updateBroomPosition();
            
            // تنظیم اندازه جارو بر اساس ارتقاها
            broomUI.style.width = (60 * upgrades.size) + 'px';
            broomUI.style.height = (100 * upgrades.size) + 'px';
            
            // فعال کردن آهنربا اگر خریداری شده
            if (upgrades.magnet) {
                magnetEffect.style.display = 'block';
            }
            
            // شروع تولید لکه‌ها
            clearInterval(stainInterval);
            stainInterval = setInterval(createStain, 1000);
            
            // شروع تولید لکه‌های ویژه
            clearInterval(specialStainInterval);
            specialStainInterval = setInterval(createSpecialStain, 15000);
            
            // شروع حلقه بازی
            cancelAnimationFrame(gameLoop);
            lastTimestamp = performance.now();
            gameLoop = requestAnimationFrame(updateGame);
        }
        
        // ایجاد لکه جدید
        function createStain() {
            if (!gameActive) return;
            
            const stain = {
                x: 20 + Math.random() * 60, // درصد از عرض جاده
                y: -50,
                size: 20 + Math.random() * 30,
                type: 'normal',
                cleaned: false
            };
            
            stains.push(stain);
        }
        
        // ایجاد لکه ویژه (سوال)
        function createSpecialStain() {
            if (!gameActive) return;
            
            const specialStain = {
                x: 20 + Math.random() * 60,
                y: -50,
                size: 40,
                type: 'special',
                cleaned: false
            };
            
            specialStains.push(specialStain);
        }
        
        // به‌روزرسانی موقعیت جارو
        function updateBroomPosition() {
            broomUI.style.left = broomPosition + '%';
            
            // به‌روزرسانی موقعیت اثر آهنربا اگر فعال باشد
            if (upgrades.magnet) {
                magnetEffect.style.display = 'block';
                magnetEffect.style.left = (broomPosition - 7.5) + '%';
                magnetEffect.style.bottom = '20px';
            }
        }
        
        // به‌روزرسانی بازی
        function updateGame(timestamp) {
            if (!gameActive) return;
            
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
            
            // پاک کردن Canvas
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // رسم جاده
            drawRoad();
            
            // به‌روزرسانی و رسم لکه‌ها
            updateAndDrawStains(deltaTime);
            
            // به‌روزرسانی و رسم لکه‌های ویژه
            updateAndDrawSpecialStains(deltaTime);
            
            // افزایش تدریجی سرعت
            if (timestamp % 1000 < 16) {
                speed += 0.05;
                speedElement.textContent = speed.toFixed(1) + 'x';
            }
            
            // بررسی ارتقا سطح
            checkLevelUp();
            
            gameLoop = requestAnimationFrame(updateGame);
        }
        
        // رسم جاده
        function drawRoad() {
            // پس‌زمینه جاده
            ctx.fillStyle = '#555';
            ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // خطوط وسط جاده
            ctx.fillStyle = 'yellow';
            const lineHeight = 40;
            const lineSpacing = 40;
            
            for (let y = 0; y < gameCanvas.height; y += lineHeight + lineSpacing) {
                ctx.fillRect(gameCanvas.width / 2 - 5, y, 10, lineHeight);
            }
        }
        
        // به‌روزرسانی و رسم لکه‌ها
        function updateAndDrawStains(deltaTime) {
            for (let i = stains.length - 1; i >= 0; i--) {
                const stain = stains[i];
                
                // حرکت لکه به پایین با سرعت فعلی
                stain.y += speed * (deltaTime / 16);
                
                // رسم لکه
                if (!stain.cleaned) {
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(
                        stain.x / 100 * gameCanvas.width,
                        stain.y,
                        stain.size / 2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    // بررسی برخورد با جارو
                    if (checkCollision(stain)) {
                        cleanStain(stain, i);
                    }
                }
                
                // اگر لکه از صفحه خارج شد
                if (stain.y > gameCanvas.height) {
                    if (!stain.cleaned) {
                        // اگر لکه تمیز نشده، بازی تمام می‌شود
                        endGame();
                        return;
                    }
                    
                    // حذف لکه تمیز شده
                    stains.splice(i, 1);
                }
            }
        }
        
        // به‌روزرسانی و رسم لکه‌های ویژه
        function updateAndDrawSpecialStains(deltaTime) {
            for (let i = specialStains.length - 1; i >= 0; i--) {
                const specialStain = specialStains[i];
                
                // حرکت لکه ویژه به پایین با سرعت فعلی
                specialStain.y += speed * (deltaTime / 16);
                
                // رسم لکه ویژه
                if (!specialStain.cleaned) {
                    // ایجاد گرادیان برای لکه طلایی
                    const gradient = ctx.createRadialGradient(
                        specialStain.x / 100 * gameCanvas.width,
                        specialStain.y,
                        0,
                        specialStain.x / 100 * gameCanvas.width,
                        specialStain.y,
                        specialStain.size / 2
                    );
                    
                    gradient.addColorStop(0, '#ffeb3b');
                    gradient.addColorStop(1, '#ff9800');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(
                        specialStain.x / 100 * gameCanvas.width,
                        specialStain.y,
                        specialStain.size / 2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    // بررسی برخورد با جارو
                    if (checkCollision(specialStain)) {
                        cleanSpecialStain(specialStain, i);
                    }
                }
                
                // اگر لکه ویژه از صفحه خارج شد
                if (specialStain.y > gameCanvas.height) {
                    specialStains.splice(i, 1);
                }
            }
        }
        
        // بررسی برخورد جارو با لکه
        function checkCollision(stain) {
            const broomRect = broomUI.getBoundingClientRect();
            const gameAreaRect = gameArea.getBoundingClientRect();
            
            // محاسبه موقعیت لکه در صفحه
            const stainX = stain.x / 100 * gameCanvas.width;
            const stainY = stain.y + gameAreaRect.top;
            
            // محاسبه مرکز جارو
            const broomCenter = {
                x: broomRect.left + broomRect.width / 2,
                y: broomRect.top + broomRect.height / 2
            };
            
            // محاسبه مرکز لکه
            const stainCenter = {
                x: stainX,
                y: stainY
            };
            
            // محاسبه فاصله
            const distance = Math.sqrt(
                Math.pow(broomCenter.x - stainCenter.x, 2) + 
                Math.pow(broomCenter.y - stainCenter.y, 2)
            );
            
            // شعاع برخورد (با در نظر گرفتن آهنربا)
            const collisionRadius = (broomRect.width / 2) + (stain.size / 2);
            const magnetRadius = upgrades.magnet ? 75 : 0;
            
            return distance < collisionRadius + magnetRadius;
        }
        
        // تمیز کردن لکه
        function cleanStain(stain, index) {
            stain.cleaned = true;
            
            // افزایش امتیاز
            score += 10;
            scoreElement.textContent = score;
            
            // شانس دریافت سکه
            if (Math.random() < 0.3) {
                coins += 1;
                coinsElement.textContent = coins;
            }
        }
        
        // تمیز کردن لکه ویژه (سوال)
        function cleanSpecialStain(specialStain, index) {
            specialStain.cleaned = true;
            
            // نمایش سوال
            showQuestion();
        }
        
        // نمایش سوال
        function showQuestion() {
            gameActive = false;
            
            // فیلتر کردن سوالات بر اساس دسته‌بندی‌های انتخاب شده
            const filteredQuestions = questions.filter(q => selectedCategories.includes(q.subject));
            
            if (filteredQuestions.length === 0) {
                // اگر سوالی موجود نیست، به بازی بازگرد
                gameActive = true;
                lastTimestamp = performance.now();
                gameLoop = requestAnimationFrame(updateGame);
                return;
            }
            
            // انتخاب سوال تصادفی
            const randomIndex = Math.floor(Math.random() * filteredQuestions.length);
            currentQuestion = filteredQuestions[randomIndex];
            
            // نمایش سوال و گزینه‌ها
            questionText.textContent = `[${currentQuestion.subject}] ${currentQuestion.question}`;
            option1.textContent = currentQuestion.options[0];
            option2.textContent = currentQuestion.options[1];
            option3.textContent = currentQuestion.options[2];
            option4.textContent = currentQuestion.options[3];
            
            // ریست کردن استایل گزینه‌ها
            option1.className = 'btn-option';
            option2.className = 'btn-option';
            option3.className = 'btn-option';
            option4.className = 'btn-option';
            
            questionResult.textContent = '';
            continueBtn.style.display = 'none';
            questionAnswered = false;
            
            showScreen('questionScreen');
        }
        
        // بررسی پاسخ سوال
        function checkAnswer(selectedOption) {
            if (questionAnswered) return;
            
            questionAnswered = true;
            const isCorrect = parseInt(selectedOption) === currentQuestion.correct;
            
            // به‌روزرسانی پیشرفت آموزشی
            learningProgress[currentQuestion.subject].total++;
            if (isCorrect) {
                learningProgress[currentQuestion.subject].correct++;
            }
            
            // رنگ‌آمیزی گزینه‌ها
            option1.classList.add(1 === currentQuestion.correct ? 'correct' : 'incorrect');
            option2.classList.add(2 === currentQuestion.correct ? 'correct' : 'incorrect');
            option3.classList.add(3 === currentQuestion.correct ? 'correct' : 'incorrect');
            option4.classList.add(4 === currentQuestion.correct ? 'correct' : 'incorrect');
            
            if (isCorrect) {
                questionResult.textContent = 'آفرین! پاسخ شما صحیح است. ۱۰ سکه دریافت کردید!';
                questionResult.style.color = '#4CAF50';
                
                // افزودن سکه
                coins += 10;
                coinsElement.textContent = coins;
            } else {
                questionResult.textContent = 'متاسفانه پاسخ شما نادرست است.';
                questionResult.style.color = '#F44336';
            }
            
            continueBtn.style.display = 'block';
        }
        
        // بررسی ارتقا سطح
        function checkLevelUp() {
            for (let i = levelThresholds.length - 1; i >= 0; i--) {
                if (score >= levelThresholds[i] && currentLevel < i + 2) {
                    levelUp(i + 2);
                    break;
                }
            }
        }
        
        // ارتقا سطح
        function levelUp(newLevel) {
            currentLevel = newLevel;
            currentLevelElement.textContent = currentLevel;
            
            // نمایش انیمیشن ارتقا سطح
            currentLevelElement.classList.add('level-up-animation');
            setTimeout(() => {
                currentLevelElement.classList.remove('level-up-animation');
            }, 500);
            
            // افزایش سرعت بازی
            speed += 0.2;
            
            // کاهش فاصله تولید لکه‌ها
            clearInterval(stainInterval);
            const newInterval = Math.max(300, 1000 - (currentLevel * 100));
            stainInterval = setInterval(createStain, newInterval);
        }
        
        // پایان بازی
        function endGame() {
            gameActive = false;
            clearInterval(stainInterval);
            clearInterval(specialStainInterval);
            cancelAnimationFrame(gameLoop);
            
            // محاسبه زمان بازی
            playTime = Math.floor((Date.now() - startTime) / 1000 / 60); // به دقیقه
            
            // محاسبه سکه‌های کسب شده
            const earnedCoins = coins;
            totalCoins += earnedCoins;
            
            // بررسی رکورد جدید
            let newRecord = false;
            if (score > highScore) {
                highScore = score;
                newRecord = true;
                playerLevel = Math.max(playerLevel, currentLevel);
            }
            
            // ذخیره داده‌ها
            saveGameData();
            
            // به‌روزرسانی صفحه پایان بازی
            finalScoreElement.textContent = score;
            newRecordElement.textContent = newRecord ? 'بله!' : 'خیر';
            earnedCoinsElement.textContent = earnedCoins;
            finalLevelElement.textContent = currentLevel;
            
            showScreen('gameOver');
        }
        
        // نمایش صفحه انتخاب دسته‌بندی
        function showCategorySelection() {
            // پر کردن لیست دسته‌بندی‌ها
            categoryList.innerHTML = '';
            
            Object.keys(learningProgress).forEach(subject => {
                const button = document.createElement('button');
                button.className = `btn category-btn ${selectedCategories.includes(subject) ? 'selected' : ''}`;
                button.setAttribute('data-subject', subject);
                button.textContent = subject;
                button.style.display = 'block';
                button.style.width = '100%';
                button.style.margin = '5px 0';
                
                button.addEventListener('click', function() {
                    const subject = this.getAttribute('data-subject');
                    
                    if (selectedCategories.includes(subject)) {
                        selectedCategories = selectedCategories.filter(s => s !== subject);
                        this.classList.remove('selected');
                    } else {
                        selectedCategories.push(subject);
                        this.classList.add('selected');
                    }
                });
                
                categoryList.appendChild(button);
            });
            
            showScreen('categoryScreen');
        }
        
        // ذخیره دسته‌بندی‌ها
        function saveCategories() {
            if (selectedCategories.length === 0) {
                alert('لطفاً حداقل یک درس را انتخاب کنید!');
                return;
            }
            
            saveGameData();
            showScreen('mainMenu');
        }
        
        // نمایش گزارش پیشرفت
        function showProgressReport() {
            // محاسبه زمان بازی
            playTimeElement.textContent = playTime + ' دقیقه';
            
            // محاسبه کل سوالات پاسخ داده شده
            let totalQuestions = 0;
            let totalCorrect = 0;
            
            for (const subject in learningProgress) {
                totalQuestions += learningProgress[subject].total;
                totalCorrect += learningProgress[subject].correct;
            }
            
            totalQuestionsElement.textContent = totalQuestions;
            
            // نمایش پیشرفت در هر درس
            subjectProgressElement.innerHTML = '';
            for (const subject in learningProgress) {
                if (learningProgress[subject].total > 0) {
                    const progressItem = document.createElement('div');
                    progressItem.className = 'progress-item';
                    
                    const percentage = Math.round((learningProgress[subject].correct / learningProgress[subject].total) * 100);
                    
                    progressItem.innerHTML = `
                        <span>${subject}</span>
                        <span>${learningProgress[subject].correct} از ${learningProgress[subject].total} (${percentage}%)</span>
                    `;
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = 'progress-fill';
                    progressFill.style.width = `${percentage}%`;
                    
                    progressBar.appendChild(progressFill);
                    
                    subjectProgressElement.appendChild(progressItem);
                    subjectProgressElement.appendChild(progressBar);
                }
            }
            
            // شناسایی نقاط قوت و ضعف
            const strengths = [];
            const weaknesses = [];
            
            for (const subject in learningProgress) {
                if (learningProgress[subject].total >= 3) { // حداقل ۳ سوال پاسخ داده شده
                    const percentage = (learningProgress[subject].correct / learningProgress[subject].total) * 100;
                    
                    if (percentage >= 70) {
                        strengths.push(subject);
                    } else if (percentage <= 40) {
                        weaknesses.push(subject);
                    }
                }
            }
            
            // نمایش نقاط قوت
            strengthsListElement.innerHTML = '';
            if (strengths.length > 0) {
                strengths.forEach(strength => {
                    const item = document.createElement('div');
                    item.className = 'progress-item';
                    item.textContent = strength;
                    strengthsListElement.appendChild(item);
                });
            } else {
                strengthsListElement.innerHTML = '<p>هنوز اطلاعات کافی برای تحلیل وجود ندارد</p>';
            }
            
            // نمایش نیاز به تمرین بیشتر
            weaknessesListElement.innerHTML = '';
            if (weaknesses.length > 0) {
                weaknesses.forEach(weakness => {
                    const item = document.createElement('div');
                    item.className = 'progress-item';
                    item.textContent = weakness;
                    weaknessesListElement.appendChild(item);
                });
            } else {
                weaknessesListElement.innerHTML = '<p>همه درس‌ها در سطح قابل قبولی هستند</p>';
            }
            
            showScreen('progressReport');
        }
        
        // خرید ارتقا
        function buyUpgrade(type) {
            let price = 0;
            
            switch(type) {
                case 'speed':
                    price = 50 * upgrades.speed;
                    if (totalCoins >= price) {
                        totalCoins -= price;
                        upgrades.speed++;
                        speedLevelElement.textContent = upgrades.speed;
                        speedPriceElement.textContent = 50 * upgrades.speed;
                        alert(`جاروی شما اکنون ${upgrades.speed}x سریع‌تر حرکت می‌کند!`);
                    } else {
                        alert('سکه کافی ندارید!');
                        return;
                    }
                    break;
                    
                case 'magnet':
                    price = 100;
                    if (totalCoins >= price && !upgrades.magnet) {
                        totalCoins -= price;
                        upgrades.magnet = true;
                        magnetEffect.style.display = 'block';
                        alert('آهنربای جارو فعال شد!');
                    } else if (upgrades.magnet) {
                        alert('شما قبلاً این ارتقا را خریداری کرده‌اید!');
                        return;
                    } else {
                        alert('سکه کافی ندارید!');
                        return;
                    }
                    break;
                    
                case 'size':
                    price = 75 * upgrades.size;
                    if (totalCoins >= price) {
                        totalCoins -= price;
                        upgrades.size++;
                        sizeLevelElement.textContent = upgrades.size;
                        sizePriceElement.textContent = 75 * upgrades.size;
                        
                        // بزرگ‌تر کردن جارو
                        broomUI.style.width = (60 * upgrades.size) + 'px';
                        broomUI.style.height = (100 * upgrades.size) + 'px';
                        
                        alert(`جاروی شما اکنون ${upgrades.size}x بزرگ‌تر شده است!`);
                    } else {
                        alert('سکه کافی ندارید!');
                        return;
                    }
                    break;
            }
            
            saveGameData();
            loadGameData();
        }
        
        // توقف/ادامه بازی
        function togglePause() {
            if (gameActive) {
                gameActive = false;
                clearInterval(stainInterval);
                clearInterval(specialStainInterval);
                cancelAnimationFrame(gameLoop);
                pauseBtn.textContent = 'ادامه';
            } else {
                gameActive = true;
                stainInterval = setInterval(createStain, 1000);
                specialStainInterval = setInterval(createSpecialStain, 15000);
                lastTimestamp = performance.now();
                gameLoop = requestAnimationFrame(updateGame);
                pauseBtn.textContent = 'توقف';
            }
        }
        
        // مدیریت رویدادهای لمسی/ماوس
        let isDragging = false;
        let startX = 0;
        let startBroomPosition = 0;
        
        gameArea.addEventListener('mousedown', startDrag);
        gameArea.addEventListener('touchstart', startDrag);
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
        
        function startDrag(e) {
            if (!gameActive) return;
            
            isDragging = true;
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            startX = clientX;
            startBroomPosition = broomPosition;
            
            e.preventDefault();
        }
        
        function drag(e) {
            if (!isDragging || !gameActive) return;
            
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const deltaX = clientX - startX;
            
            // محاسبه موقعیت جدید جارو با در نظر گرفتن سرعت ارتقا
            const sensitivity = 0.5 * upgrades.speed;
            broomPosition = startBroomPosition + (deltaX / gameArea.offsetWidth) * 100 * sensitivity;
            
            // محدود کردن جارو به داخل جاده
            broomPosition = Math.max(20, Math.min(80, broomPosition));
            
            updateBroomPosition();
            
            e.preventDefault();
        }
        
        function endDrag() {
            isDragging = false;
        }
        
        // مدیریت دکمه‌ها
        startBtn.addEventListener('click', startGame);
        tutorialBtn.addEventListener('click', () => showScreen('tutorial'));
        shopBtn.addEventListener('click', () => showScreen('shop'));
        categoryBtn.addEventListener('click', showCategorySelection);
        pauseBtn.addEventListener('click', togglePause);
        restartBtn.addEventListener('click', startGame);
        menuBtn.addEventListener('click', () => {
            loadGameData();
            showScreen('mainMenu');
        });
        shopBackBtn.addEventListener('click', () => {
            loadGameData();
            showScreen('mainMenu');
        });
        continueBtn.addEventListener('click', () => {
            gameActive = true;
            lastTimestamp = performance.now();
            gameLoop = requestAnimationFrame(updateGame);
            showScreen('gameScreen');
        });
        tutorialCloseBtn.addEventListener('click', startGame);
        reportBtn.addEventListener('click', showProgressReport);
        reportCloseBtn.addEventListener('click', () => showScreen('gameOver'));
        categorySaveBtn.addEventListener('click', saveCategories);
        
        // مدیریت گزینه‌های سوال
        option1.addEventListener('click', () => checkAnswer(1));
        option2.addEventListener('click', () => checkAnswer(2));
        option3.addEventListener('click', () => checkAnswer(3));
        option4.addEventListener('click', () => checkAnswer(4));
        
        // مدیریت ارتقاها
        document.querySelectorAll('.upgrade-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const upgradeType = this.getAttribute('data-upgrade');
                buyUpgrade(upgradeType);
            });
        });
        
        // بارگذاری اولیه داده‌های بازی
        loadGameData();
    </script>
</body>
</html>